services:
  # Node 1 - Bootstrap node (initial leader)
  node1:
    build:
      context: ../..
      dockerfile: deployments/docker/Dockerfile
    container_name: raftkv-node1
    hostname: node1
    networks:
      - raftkv-network
    ports:
      - "8081:8080" # HTTP API
      - "9091:9090" # gRPC API
      - "7001:7000" # Raft
    volumes:
      - node1-data:/data
      - ./config/node1.yaml:/config/node.yaml:ro
    command: [ "--config=/config/node.yaml" ]
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health" ]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s

  # Node 2 - Follower
  node2:
    build:
      context: ../..
      dockerfile: deployments/docker/Dockerfile
    container_name: raftkv-node2
    hostname: node2
    networks:
      - raftkv-network
    ports:
      - "8082:8080"
      - "9092:9090"
      - "7002:7000"
    volumes:
      - node2-data:/data
      - ./config/node2.yaml:/config/node.yaml:ro
    entrypoint: [ "/bin/sh", "-c", "sleep 5 && /usr/local/bin/kvstore --config=/config/node.yaml" ]
    depends_on:
      node1:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health" ]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s

  # Node 3 - Follower
  node3:
    build:
      context: ../..
      dockerfile: deployments/docker/Dockerfile
    container_name: raftkv-node3
    hostname: node3
    networks:
      - raftkv-network
    ports:
      - "8083:8080"
      - "9093:9090"
      - "7003:7000"
    volumes:
      - node3-data:/data
      - ./config/node3.yaml:/config/node.yaml:ro
    entrypoint: [ "/bin/sh", "-c", "sleep 5 && /usr/local/bin/kvstore --config=/config/node.yaml" ]
    depends_on:
      node1:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health" ]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s

  # HAProxy Load Balancer (optional)
  haproxy:
    image: haproxy:2.8-alpine
    container_name: raftkv-haproxy
    networks:
      - raftkv-network
    ports:
      - "8080:8080" # HTTP load balanced
      - "9090:9090" # gRPC load balanced
      - "8404:8404" # HAProxy stats
    volumes:
      - ./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    depends_on:
      - node1
      - node2
      - node3
    healthcheck:
      test: [ "CMD", "haproxy", "-c", "-f", "/usr/local/etc/haproxy/haproxy.cfg" ]
      interval: 10s
      timeout: 3s
      retries: 3

networks:
  raftkv-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

volumes:
  node1-data:
    driver: local
  node2-data:
    driver: local
  node3-data:
    driver: local
